{% extends "base.html" %}

{% block title %}Customer Home{% endblock %}

{% block extra_css %}
<style>
    /* --- Dark Particle Background --- */
    body.customer-page {
        background-color: #111827; /* Dark background */
        color: #e5e7eb;
        position: relative;
        overflow-x: hidden;
    }

    #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
    }

    /* --- Existing Customer Styles --- */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .product-col {
        opacity: 0;
        animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Staggered delays */
    .product-col:nth-child(1) { animation-delay: 0.1s; }
    .product-col:nth-child(2) { animation-delay: 0.2s; }
    .product-col:nth-child(3) { animation-delay: 0.3s; }
    .product-col:nth-child(4) { animation-delay: 0.4s; }
    .product-col:nth-child(5) { animation-delay: 0.5s; }

    /* "Lift & Glow" Effect */
    .product-card {
        position: relative; 
        overflow: hidden;   
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 0 15px rgba(79, 70, 229, 0.3); 
    }

    /* "Glass Shine" Effect */
    .product-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -80%; 
        width: 60%;
        height: 100%;
        background: linear-gradient(
            to right, 
            rgba(255, 255, 255, 0) 0%, 
            rgba(255, 255, 255, 0.3) 50%, 
            rgba(255, 255, 255, 0) 100%
        );
        transform: skewX(-25deg); 
        transition: left 0.6s ease-in-out;
    }
    .product-card:hover::before {
        left: 120%; 
    }

    /* Image Zoom */
    .product-image-container {
        overflow: hidden;
        height: 200px;
        border-top-left-radius: var(--bs-card-border-radius);
        border-top-right-radius: var(--bs-card-border-radius);
    }
    .product-image-container img {
        transition: transform 0.3s ease-out; 
    }
    .product-card:hover .product-image-container img {
        transform: scale(1.1); 
    }

    /* Button "Pop & Fill" */
    .btn-view-product {
        transition: transform 0.2s ease-out, background-color 0.2s ease, color 0.2s ease;
    }
    .btn-view-product:hover {
        transform: scale(1.1); 
        background-color: var(--primary-color);
        color: #fff; 
        border-color: var(--primary-color);
    }

    /* Pagination */
    .pagination {
        justify-content: center;
    }
    .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<body class="customer-page">
<div id="particles-js"></div>

<div class="container mt-4">
    <div class="row">
        <!-- Filters (Optional Sidebar) -->
        <div class="col-lg-3">
            <div class="card mb-4 product-col" style="animation-delay: 0s;">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Categories</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('customer_home', sort=selected_sort) }}" 
                       class="list-group-item list-group-item-action {% if not selected_category %}active{% endif %}">
                        All Products
                    </a>
                    {% for category in categories %}
                    <a href="{{ url_for('customer_home', category_id=category.category_id, sort=selected_sort) }}" 
                       class="list-group-item list-group-item-action {% if selected_category == category.category_id %}active{% endif %}">
                        {{ category.category_name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Product Listing -->
        <div class="col-lg-9">
            <!-- Sorting Dropdown -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Our Products</h2>
                <form action="{{ url_for('customer_home') }}" method="GET" id="filterSortForm">
                    {% if selected_category %}
                    <input type="hidden" name="category_id" value="{{ selected_category }}">
                    {% endif %}
                    <div class="d-flex align-items-center">
                        <label for="sort" class="form-label mb-0 me-2">Sort by:</label>
                        <select name="sort" id="sort" class="form-select" onchange="this.form.submit()">
                            <option value="name_asc" {% if selected_sort == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                            <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>Price (Low to High)</option>
                            <option value="price_desc" {% if selected_sort == 'price_desc' %}selected{% endif %}>Price (High to Low)</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
                {% for product in products %}
                <div class="col product-col">
                    <div class="card h-100 shadow-sm product-card">
                        <div class="product-image-container">
                            <img src="{{ product.image_url | default('https://placehold.co/600x400/eeeeee/aaaaaa?text=No+Image') }}" 
                                 class="card-img-top" 
                                 alt="{{ product.product_name }}" 
                                 style="height: 200px; object-fit: cover;"
                                 onerror="this.src='https://placehold.co/600x400/eeeeee/aaaaaa?text=No+Image'">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ product.product_name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ product.brand }}</h6>
                            <p class="card-text">
                                <span class="badge bg-info">{{ product.category_name }}</span>
                            </p>
                            <p class="card-text small">{{ product.description|truncate(100) }}</p>
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="h5 text-success">
                                        {% if product.best_price %}
                                            Best Price: ₹{{ "%.2f"|format(product.best_price) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    {% if product.max_discount > 0 %}
                                    <span class="badge bg-danger ms-1">{{ "%.0f"|format(product.max_discount) }}% OFF</span>
                                    {% endif %}
                                </div>
                                <a href="{{ url_for('customer_product_detail', product_id=product.product_id) }}" class="btn btn-sm btn-outline-primary btn-view-product">
                                    View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if total_pages > 1 %}
            <nav aria-label="Product pagination" class="mt-4">
                <ul class="pagination">
                    {% for page_num in range(1, total_pages + 1) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('customer_home', page=page_num, category_id=selected_category, sort=selected_sort) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

{% if triggered_alerts %}
<div class="modal fade" id="priceAlertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Price Drop!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="fs-5">Good news! One or more of your price alerts have been triggered:</p>
                <ul class="list-group">
                    {% for alert in triggered_alerts %}
                    <li class="list-group-item">
                        <strong>{{ alert.product_name }}</strong> at {{ alert.store_name }}
                        <br>
                        <small>Your target was ₹{{ "%.2f"|format(alert.target_price | float) }}, and the price is now <strong class="text-success">₹{{ "%.2f"|format(alert.price_in_store | float) }}</strong>!</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Great, thanks!</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
</body>
{% endblock %}

{% block extra_js %}
{% if triggered_alerts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var alertModalElement = document.getElementById('priceAlertModal');
        var priceAlertModal = new bootstrap.Modal(alertModalElement);
        priceAlertModal.show();
    });
</script>
{% endif %}

<!-- Particles.js Initialization -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
particlesJS("particles-js", {
    "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#34d399" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": true },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#374151", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 2 }
    },
    "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true },
        "modes": { "grab": { "distance": 140, "line_opacity": 1 }, "push": { "particles_nb": 4 } }
    },
    "retina_detect": true
});
</script>
{% endblock %}
